<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Budget</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 720px;
      margin: 2rem auto
    }
  </style>
</head>

<body>
  <h1>Transactions</h1>
  <div>
    <label>Description: <input id="desc" placeholder="e.g., Coffee"></label>
    <label>Amount (NZD): <input id="amt" type="number" step="0.01" value="1.00"></label>
    <button id="add">Add</button>
  </div>
  <ul id="list"></ul>

  <script>
    // Simple HTML escape function to prevent XSS in this demo app, not needed, but found it and thought it'd be good practice to include :)
    function escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }

    async function getTransactions() {
      const response = await fetch(`/api/transactions`);
      if (!response.ok) throw new Error(`GET failed: ${response.status}`);
      const rows = await response.json();
      document.getElementById('list').innerHTML = rows.map(x =>
        `<li>${new Date(x.occurred_at).toLocaleString()} — ${escapeHtml(x.description)} — $${(x.amount_cents / 100).toFixed(2)}</li>`
      ).join('');
    }

    async function addTransaction() {
      const desc = document.getElementById('desc').value.trim();
      const amt = parseFloat(document.getElementById('amt').value);
      if (!desc || !Number.isFinite(amt)) return alert('Enter a description and amount');
      const cents = Math.round(amt * 100);
      const response = await fetch(`/api/transactions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: desc, amount_cents: cents })
      });
      // Handle response, see why it failed, again
      if (!response.ok) { const t = await response.text(); return alert(`POST failed: ${response.status} ${t}`); }
      await getTransactions();
    }

    document.getElementById('add').addEventListener('click', addTransaction);
    getTransactions();
  </script>
</body>

</html>